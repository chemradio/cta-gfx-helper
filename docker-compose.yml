version: '3.9'

services:
  db:
    restart: always
    environment:
      IS_DOCKER: 1
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    hostname: db
    image: postgres:15-alpine
    volumes:
       - ./pg_data:/var/lib/postgresql/data
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "0.20"
    #       memory: "0.5G"
  dispatcher:
    restart: always
    build: ./dispatcher_engine
    platform: ${PLATFORM}
    depends_on:
    - db
    environment:
      IS_DOCKER: 1
      BOT_ADMIN_EMAIL: ${BOT_ADMIN_EMAIL}
      BOT_ADMIN_PASSWORD: ${BOT_ADMIN_PASSWORD}
      BOT_TOKEN: ${BOT_TOKEN}
      JWT_SECRET: ${JWT_SECRET}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REGISTER_PASSPHRASE: ${REGISTER_PASSPHRASE}
    hostname: dispatcher
    ports:
      - "9000:9000"
    # image: ctagfx.azurecr.io/rg-inno-prod-graphichelper-test:dispatcher
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "0.20"
    #       memory: 1G
  front-svelte:
    restart: always
    build: ./front_svelte
    platform: ${PLATFORM}
    # depends_on:
    # - dispatcher
    hostname: front_svelte
    # image: ctagfx.azurecr.io/rg-inno-prod-graphichelper-test:front_svelte
    ports:
      - "80:80"
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "0.20"
    #       memory: 1G
  bot-engine:
    restart: always
    build: ./bot_engine
    platform: ${PLATFORM}
    environment:
      IS_DOCKER: 1
      BOT_ADMIN: ${BOT_ADMIN}
      BOT_TOKEN: ${BOT_TOKEN}
    # depends_on:
    # - dispatcher
    hostname: bot_engine
    # image: ctagfx.azurecr.io/rg-inno-prod-graphichelper-test:front_svelte
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "0.20"
    #       memory: 1G
  screenshot-selenium:
    restart: always
    hostname: screenshot_selenium
    image: ${SELENIUM_IMAGE}
    privileged: true
    shm_size: 2g
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "0.50"
    #       memory: 2G
  screenshoter:
    restart: always
    build: ./screenshot_engine
    platform: ${PLATFORM}
    environment:
      IS_DOCKER: 1
    depends_on:
    - dispatcher
    hostname: screenshoter
    # image: ctagfx.azurecr.io/rg-inno-prod-graphichelper-test:screenshoter
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "0.50"
    #       memory: "0.2G"
  storage-unit:
    restart: always
    build: ./storage_unit
    platform: ${PLATFORM}
    environment:
      IS_DOCKER: 1
    depends_on:
    - dispatcher
    hostname: storage_unit
    # image: ctagfx.azurecr.io/rg-inno-prod-graphichelper-test:storage_unit
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "0.10"
    #       memory: "0.2G"
  video-gfx:
    restart: always
    build: ./video_gfx
    platform: ${PLATFORM}
    environment:
      IS_DOCKER: 1
    depends_on:
    - dispatcher
    hostname: video_gfx
    # image: ctagfx.azurecr.io/rg-inno-prod-graphichelper-test:video_gfx
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "1.00"
    #       memory: 1G
  video-gfx-selenium:
    restart: always
    hostname: video_gfx_selenium
    image: ${SELENIUM_IMAGE}
    privileged: true
    shm_size: 2g
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "1.00"
    #       memory: 2G
